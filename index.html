<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NFC Tap to Pay</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      background: #121212;
      color: white;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    .card {
      background: linear-gradient(135deg, #2c3e50, #4ca1af);
      padding: 20px;
      border-radius: 20px;
      width: 300px;
      text-align: center;
      box-shadow: 0 8px 20px rgba(0,0,0,0.5);
      margin: 20px 0;
    }
    button {
      padding: 10px 20px;
      margin: 10px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
    }
    .sender { background: #3498db; color: white; }
    .receiver { background: #27ae60; color: white; }
    .success {
      background: #2ecc71;
      color: black;
      padding: 15px;
      margin-top: 15px;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <h1>üí≥ NFC Credit Card Demo</h1>
  <div>
    <button class="sender" onclick="setMode('sender')">I'm Sender</button>
    <button class="receiver" onclick="setMode('receiver')">I'm Receiver</button>
  </div>

  <div class="card" id="card">
    <h2 id="modeLabel">Select Mode</h2>
    <p>Card No: <span id="cardId">---</span></p>
    <p>Balance: ‚Çπ<span id="balance">0</span></p>
  </div>

  <div id="status" class="success" style="display:none;"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getDatabase, ref, set, update, get, child } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCUe6603zIO6_8ghw09iGxqq79pcx4oK7o",
      authDomain: "nfc-3dd64.firebaseapp.com",
      databaseURL: "https://nfc-3dd64-default-rtdb.firebaseio.com",
      projectId: "nfc-3dd64",
      storageBucket: "nfc-3dd64.appspot.com",
      messagingSenderId: "536652690858",
      appId: "1:536652690858:web:6f602deabe5a3cc50ce7d3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let mode = '';
    let cardId = 'CARD123';
    let balance = 0;

    window.setMode = async function(m) {
      mode = m;
      document.getElementById('modeLabel').innerText = m === 'sender' ? 'Sender Mode' : 'Receiver Mode';
      document.getElementById('cardId').innerText = cardId;

      if (mode === 'sender') {
        balance = 999999;
        await set(ref(db, 'cards/' + cardId), { balance });
        updateUI();
        writeCardIdToNFC();
      } else {
        listenForNFC();
      }
    }

    function updateUI() {
      document.getElementById('balance').innerText = balance;
    }

    function showStatus(msg) {
      const s = document.getElementById('status');
      s.style.display = 'block';
      s.innerText = msg;
      setTimeout(() => s.style.display = 'none', 4000);
    }

    async function listenForNFC() {
      if (!("NDEFReader" in window)) {
        alert("Web NFC not supported.");
        return;
      }
      try {
        const reader = new NDEFReader();
        await reader.scan();
        showStatus("üì° Waiting for sender tap...");
        reader.onreading = async event => {
          const decoder = new TextDecoder();
          const scannedId = decoder.decode(event.message.records[0].data);
          const senderRef = ref(db, 'cards/' + scannedId);
          const snapshot = await get(senderRef);
          if (snapshot.exists()) {
            let senderBal = snapshot.val().balance || 0;
            if (senderBal >= 1000) {
              await update(senderRef, { balance: senderBal - 1000 });
              balance += 1000;
              updateUI();
              showStatus("‚úÖ ‚Çπ1000 received from " + scannedId);
            } else {
              showStatus("‚ùå Insufficient funds.");
            }
          } else {
            showStatus("‚ùå Card not found.");
          }
        };
      } catch (err) {
        alert("‚ùå NFC Error: " + err);
      }
    }

    async function writeCardIdToNFC() {
      if (!("NDEFWriter" in window)) return;
      try {
        const writer = new NDEFWriter();
        await writer.write(cardId);
        showStatus("‚úÖ Card ID written to NFC");
      } catch (e) {
        showStatus("‚ùå Write failed: " + e);
      }
    }
  </script>
</body>
</html>
