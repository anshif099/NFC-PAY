<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Web NFC P2P Triggered Transfer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { background:#121212; color:#fff; font-family:sans-serif; padding:20px; }
    .container { max-width:420px; margin:auto; background:#1f1f1f; padding:20px; border-radius:12px; }
    input,button { width:100%; padding:12px; margin-top:10px; border:none; border-radius:8px; font-size:16px; }
    button { background:#00ff88; color:#000; font-weight:bold; }
    #dashboard, #receiverControls { display:none; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Web NFC Triggered P2P Transfer</h2>

    <div id="loginForm">
      <input id="loginUser" placeholder="Username">
      <input id="loginPIN" placeholder="PIN" type="password">
      <button onclick="login()">Login / Register</button>
    </div>

    <div id="dashboard">
      <p>Welcome, <span id="meLabel"></span> | Balance: ₹<span id="myBal">0</span></p>
      <hr>

      <h3>Sender Controls</h3>
      <input id="sendTo" placeholder="Recipient Username">
      <input id="sendAmt" type="number" placeholder="Amount to Send">
      <button id="btnSend" onclick="startSend()">Tap To Send</button>

      <hr>

      <h3>Receiver Setup</h3>
      <button id="btnEnableRec" onclick="enableReceiver()">Enable NFC Tap</button>
      <p id="recHint">Tap once after sending to refresh token.</p>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js';
    import {
      getDatabase, ref, child, get, set, update, runTransaction
    } from 'https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js';

    const app = initializeApp({
      apiKey: "...",
      authDomain: "nfc-3dd64.firebaseapp.com",
      databaseURL: "https://nfc-3dd64-default-rtdb.firebaseio.com",
      projectId: "nfc-3dd64"
    });
    const db = getDatabase(app);

    let me, myPIN, sessionToken = null;

    async function login() {
      me = document.getElementById("loginUser").value.trim();
      myPIN = document.getElementById("loginPIN").value.trim();
      if (!me || !myPIN) return alert("Enter both username & PIN");

      const uRef = ref(db, 'users/' + me);
      const snap = await get(uRef);
      if (!snap.exists()) {
        await set(uRef, { balance:1000, pin:myPIN });
      } else if (snap.val().pin !== myPIN) {
        return alert("Incorrect PIN");
      }

      document.getElementById("meLabel").innerText = me;
      document.getElementById("loginForm").style.display = 'none';
      document.getElementById("dashboard").style.display = 'block';

      refreshBalance();
    }

    async function refreshBalance() {
      const snap = await get(ref(db, 'users/' + me + '/balance'));
      document.getElementById("myBal").innerText = snap.val() ?? 0;
    }

    function genToken() {
      return crypto.randomUUID();
    }

    async function startSend() {
      const to = document.getElementById("sendTo").value.trim();
      const amt = parseInt(document.getElementById("sendAmt").value,10);
      const btn = document.getElementById("btnSend");
      if (!to || !amt || amt<=0 || to===me) return alert("Invalid recipient or amount");

      const rsnap = await get(ref(db,'users/'+to));
      if (!rsnap.exists()) return alert("Recipient not found");

      sessionToken = genToken();
      await set(ref(db,'sessions/'+sessionToken), {
        from:me, to:to, amt:amt, used:false
      });

      btn.disabled = true;
      btn.innerText = "Tap receiver's tag";
      alert("NFC ready. Tap tag on receiver to transfer.");

      if ("NDEFReader" in window) {
        try {
          const reader = new NDEFReader();
          await reader.scan();
          reader.onreading = ev => {
            const data = new TextDecoder().decode(ev.message.records[0].data);
            if (data === sessionToken) completeTransfer();
          };
        } catch(e){ alert("Scan error: "+e.message); resetSendButton(); }
      } else alert("Web NFC not supported");
    }

    async function completeTransfer() {
      const snap = await get(ref(db,'sessions/'+sessionToken));
      if (!snap.exists() || snap.val().used) return alert("Invalid or used token");
      const {from,to,amt} = snap.val();

      await runTransaction(ref(db,'users/'+from+'/balance'), b => b>=amt ? b-amt : undefined);
      await runTransaction(ref(db,'users/'+to+'/balance'), b => b+amt);
      await update(ref(db,'sessions/'+sessionToken), {used:true});

      alert(`✅ ₹${amt} from ${from} → ${to}`);
      resetSendButton();
      refreshBalance();
    }

    function resetSendButton() {
      document.getElementById("btnSend").disabled=false;
      document.getElementById("btnSend").innerText="Tap To Send";
      sessionToken = null;
    }

    async function enableReceiver() {
      if (!("NDEFWriter" in window)) return alert("Write on NFC unsupported");

      if (!sessionToken) {
        return alert("Start a transfer first");
      }

      try {
        const writer = new NDEFWriter();
        await writer.write({records: [{recordType:"text", data:sessionToken}]});
        alert("Receiver exposed token. Awaiting tap...");
      } catch(e){
        alert("Write failed: "+e.message);
      }
    }
  </script>
</body>
</html>
