<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>NFC Money Transfer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: sans-serif; background: #121212; color: white; text-align: center; padding: 20px; }
    input, button { padding: 10px; margin: 10px; border-radius: 8px; font-size: 16px; }
  </style>
</head>
<body>
  <h2>NFC Money Transfer</h2>

  <select id="mode">
    <option value="receiver">Receiver</option>
    <option value="sender">Sender</option>
  </select>

  <div id="receiver-ui" style="display:none;">
    <input type="text" id="receiverId" placeholder="Your Name (Receiver)">
    <input type="number" id="amount" placeholder="Amount to Receive">
    <button onclick="startReceiver()">Start Waiting</button>
  </div>

  <div id="sender-ui" style="display:none;">
    <input type="text" id="senderId" placeholder="Your Name (Sender)">
    <button onclick="startSender()">Tap to Pay (Scan NFC)</button>
  </div>

  <div id="status"></div>

  <script type="module">
    // ✅ Firebase Setup
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCUe6603zIO6_8ghw09iGxqq79pcx4oK7o",
      authDomain: "nfc-3dd64.firebaseapp.com",
      databaseURL: "https://nfc-3dd64-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "nfc-3dd64",
      storageBucket: "nfc-3dd64.appspot.com",
      messagingSenderId: "1050109212357",
      appId: "1:1050109212357:web:1b859e8dcaf17e8c57bbfe"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const modeSelect = document.getElementById('mode');
    const receiverUI = document.getElementById('receiver-ui');
    const senderUI = document.getElementById('sender-ui');
    const statusDiv = document.getElementById('status');

    modeSelect.addEventListener('change', () => {
      receiverUI.style.display = modeSelect.value === "receiver" ? "block" : "none";
      senderUI.style.display = modeSelect.value === "sender" ? "block" : "none";
      statusDiv.textContent = "";
    });

    async function startReceiver() {
      const receiverId = document.getElementById('receiverId').value;
      const amount = parseInt(document.getElementById('amount').value);

      if (!receiverId || isNaN(amount)) {
        statusDiv.textContent = "Please fill all fields.";
        return;
      }

      const payload = { receiverId, amount };

      if ('NDEFReader' in window) {
        try {
          const ndef = new NDEFReader();
          await ndef.write(JSON.stringify(payload));
          statusDiv.textContent = `Waiting... Ask sender to tap. (₹${amount})`;
        } catch (err) {
          statusDiv.textContent = "NFC Write failed: " + err;
        }
      } else {
        statusDiv.textContent = "NFC not supported on this device.";
      }
    }

    async function startSender() {
      const senderId = document.getElementById('senderId').value;
      if (!senderId) {
        statusDiv.textContent = "Please enter sender ID.";
        return;
      }

      if ('NDEFReader' in window) {
        try {
          const ndef = new NDEFReader();
          await ndef.scan();
          statusDiv.textContent = "Scanning for NFC tag...";

          ndef.onreading = async (event) => {
            const data = JSON.parse(event.message.records[0].data);
            const { receiverId, amount } = data;

            const senderRef = ref(db, 'users/' + senderId);
            const receiverRef = ref(db, 'users/' + receiverId);

            const senderSnap = await get(senderRef);
            const receiverSnap = await get(receiverRef);

            let senderBalance = senderSnap.exists() ? senderSnap.val().balance : 10000;
            let receiverBalance = receiverSnap.exists() ? receiverSnap.val().balance : 0;

            if (senderBalance >= amount) {
              senderBalance -= amount;
              receiverBalance += amount;

              await update(senderRef, { balance: senderBalance });
              await update(receiverRef, { balance: receiverBalance });

              statusDiv.textContent = `₹${amount} sent to ${receiverId}. Remaining balance: ₹${senderBalance}`;
            } else {
              statusDiv.textContent = "Insufficient balance!";
            }
          };
        } catch (err) {
          statusDiv.textContent = "NFC Scan failed: " + err;
        }
      } else {
        statusDiv.textContent = "NFC not supported on this device.";
      }
    }
  </script>
</body>
</html>
